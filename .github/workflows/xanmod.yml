name: Sync Latest XanMod RT Kernel

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  sync-latest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl xmlstarlet

      - name: Get latest RT version from RSS
        id: getver
        run: |
          RSS_URL="https://sourceforge.net/p/xanmod/activity/feed.rss"

          # 取最新 item title
          LATEST_TITLE=$(curl -s "$RSS_URL" | xmlstarlet sel -t -v "//item/title[1]")

          # 提取 RT 核心版本，如 6.18.10-rt-x64v3-xanmod1
          VERSION=$(echo "$LATEST_TITLE" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+-rt(-x64v[23])?-xanmod[0-9]+')

          if [ -z "$VERSION" ]; then
            echo "Failed to parse latest RT version from RSS"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Latest RT version: $VERSION"

      - name: Download latest deb packages
        run: |
          VERSION=${{ steps.getver.outputs.version }}
          BASE_DIR="kernel"
          mkdir -p $BASE_DIR/x64v2
          mkdir -p $BASE_DIR/x64v3

          BASE_URL="https://sourceforge.net/projects/xanmod/files/releases/rt"

          # 获取目录名（去掉 -x64v3-xanmod1）
          DIR_VERSION=${VERSION%-x64v3-xanmod1}

          # 下载 x64v2
          curl -L -o $BASE_DIR/x64v2/linux-image.deb \
            "$BASE_URL/$DIR_VERSION/$DIR_VERSION-x64v2-xanmod1/linux-image-$DIR_VERSION-x64v2-xanmod1.deb/download"

          # 下载 x64v3
          curl -L -o $BASE_DIR/x64v3/linux-image.deb \
            "$BASE_URL/$DIR_VERSION/$VERSION/linux-image-$VERSION.deb/download"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add kernel/x64v2/linux-image.deb kernel/x64v3/linux-image.deb

          if git diff --cached --quiet; then
            echo "No changes detected"
          else
            git commit -m "Update latest XanMod RT kernel"
            git push
