name: Download XanMod RT Kernel Packages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # 每周一自动检查更新

jobs:
  download-kernels:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse RSS and download latest RT kernels
        run: |
          set -e

          # 获取 RSS feed
          RSS=$(curl -fsSL "https://sourceforge.net/p/xanmod/activity/feed.rss")

          # 打印 RSS 内容用于调试
          echo "=== RSS Content (first 100 lines) ==="
          echo "$RSS" | head -100

          # 从 RSS 中直接提取所有 .deb/download 链接
          ALL_DEBS=$(echo "$RSS" | grep -oP 'https://sourceforge\.net/projects/xanmod/files/[^"<\s]+\.deb/download' | sort -u)

          echo ""
          echo "=== All .deb links found ==="
          echo "$ALL_DEBS"

          # 筛选 rt x64v3 相关的 deb（image / headers / libc-dev）
          IMAGE_V3=$(echo  "$ALL_DEBS" | grep 'x64v3' | grep 'linux-image'   | sort -V | tail -n1)
          HEADERS_V3=$(echo "$ALL_DEBS" | grep 'x64v3' | grep 'linux-headers' | sort -V | tail -n1)
          LIBC_V3=$(echo   "$ALL_DEBS" | grep 'x64v3' | grep 'linux-libc-dev' | sort -V | tail -n1)

          # 筛选 rt x64v2 相关的 deb
          IMAGE_V2=$(echo  "$ALL_DEBS" | grep 'x64v2' | grep 'linux-image'   | sort -V | tail -n1)
          HEADERS_V2=$(echo "$ALL_DEBS" | grep 'x64v2' | grep 'linux-headers' | sort -V | tail -n1)
          LIBC_V2=$(echo   "$ALL_DEBS" | grep 'x64v2' | grep 'linux-libc-dev' | sort -V | tail -n1)

          echo ""
          echo "=== x64v3 URLs ==="
          echo "Image:   $IMAGE_V3"
          echo "Headers: $HEADERS_V3"
          echo "LibcDev: $LIBC_V3"

          echo ""
          echo "=== x64v2 URLs ==="
          echo "Image:   $IMAGE_V2"
          echo "Headers: $HEADERS_V2"
          echo "LibcDev: $LIBC_V2"

          # 检查是否找到了链接
          if [ -z "$IMAGE_V3" ] || [ -z "$IMAGE_V2" ]; then
            echo ""
            echo "ERROR: Could not find deb links. Dumping full RSS for inspection:"
            echo "$RSS"
            exit 1
          fi

          # 创建输出目录
          mkdir -p kernel/x64v3
          mkdir -p kernel/x64v2

          # 下载 x64v3
          echo ""
          echo "=== Downloading x64v3 packages ==="
          cd kernel/x64v3
          wget -q --content-disposition "$IMAGE_V3"
          wget -q --content-disposition "$HEADERS_V3"
          [ -n "$LIBC_V3" ] && wget -q --content-disposition "$LIBC_V3" || true
          ls -lh .
          cd ../..

          # 下载 x64v2
          echo ""
          echo "=== Downloading x64v2 packages ==="
          cd kernel/x64v2
          wget -q --content-disposition "$IMAGE_V2"
          wget -q --content-disposition "$HEADERS_V2"
          [ -n "$LIBC_V2" ] && wget -q --content-disposition "$LIBC_V2" || true
          ls -lh .
          cd ../..

      - name: List all downloaded files
        run: |
          echo "=== kernel/x64v3 ==="
          ls -lh kernel/x64v3/
          echo ""
          echo "=== kernel/x64v2 ==="
          ls -lh kernel/x64v2/

      - name: Upload x64v3 kernel packages as artifact
        uses: actions/upload-artifact@v4
        with:
          name: xanmod-rt-x64v3-xanmod1
          path: kernel/x64v3/
          retention-days: 30

      - name: Upload x64v2 kernel packages as artifact
        uses: actions/upload-artifact@v4
        with:
          name: xanmod-rt-x64v2-xanmod1
          path: kernel/x64v2/
          retention-days: 30

      - name: Commit and push downloaded packages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add kernel/
          git diff --staged --quiet || git commit -m "chore: update XanMod RT kernel packages $(date +'%Y-%m-%d')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
